{% extends "base.html" %}
{% block nav_dashboard %}text-white active{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-4xl font-black text-white">Dashboard</h1>
            <p class="text-gray-500 text-sm mt-1">Coaching staff email collection system</p>
        </div>
        <button id="crawl-btn" onclick="startCrawl()"
            class="relative bg-emerald-600 hover:bg-emerald-500 active:scale-95 text-white px-12 py-3.5 rounded-xl font-black text-lg uppercase tracking-wider transition-all shadow-lg hover:shadow-emerald-500/25 glow-emerald">
            CRAWL
        </button>
    </div>

    <!-- Top stats (4 cards) -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Emails -->
        <div class="glass rounded-2xl p-5 glow-emerald relative overflow-hidden group">
            <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-emerald-500 to-emerald-300"></div>
            <div class="absolute -right-4 -top-4 w-20 h-20 rounded-full bg-emerald-500/5 group-hover:bg-emerald-500/10 transition"></div>
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Total Emails</p>
                    <p id="stat-emails" class="text-4xl font-black text-emerald-400 mt-2">--</p>
                </div>
                <svg class="w-7 h-7 text-emerald-800" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/></svg>
            </div>
            <p id="stat-emails-delta" class="text-xs text-emerald-600 mt-2 hidden">+0 this session</p>
        </div>
        <!-- Schools -->
        <div class="glass rounded-2xl p-5 glow-blue relative overflow-hidden group">
            <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-blue-500 to-blue-300"></div>
            <div class="absolute -right-4 -top-4 w-20 h-20 rounded-full bg-blue-500/5 group-hover:bg-blue-500/10 transition"></div>
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Schools</p>
                    <p id="stat-schools" class="text-4xl font-black text-blue-400 mt-2">--</p>
                </div>
                <svg class="w-7 h-7 text-blue-800" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5"/></svg>
            </div>
        </div>
        <!-- Crawled -->
        <div class="glass rounded-2xl p-5 glow-amber relative overflow-hidden group">
            <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-amber-500 to-amber-300"></div>
            <div class="absolute -right-4 -top-4 w-20 h-20 rounded-full bg-amber-500/5 group-hover:bg-amber-500/10 transition"></div>
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Crawled</p>
                    <p id="stat-crawled" class="text-4xl font-black text-amber-400 mt-2">--</p>
                </div>
                <svg class="w-7 h-7 text-amber-800" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
        </div>
        <!-- Pending -->
        <div class="glass rounded-2xl p-5 relative overflow-hidden group">
            <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-gray-600 to-gray-500"></div>
            <div class="absolute -right-4 -top-4 w-20 h-20 rounded-full bg-gray-500/5 group-hover:bg-gray-500/10 transition"></div>
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Pending</p>
                    <p id="stat-pending" class="text-4xl font-black text-gray-400 mt-2">--</p>
                </div>
                <svg class="w-7 h-7 text-gray-700" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
        </div>
    </div>

    <!-- Level breakdown -->
    <div class="grid grid-cols-3 gap-4">
        <div class="glass rounded-xl p-4 glow-blue">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs text-gray-500 uppercase font-semibold">College</p>
                <span class="px-2 py-0.5 rounded-full text-xs bg-blue-900/50 text-blue-400 font-bold">LVL 1</span>
            </div>
            <p id="stat-college" class="text-3xl font-black text-blue-400">--</p>
            <div class="mt-2 w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="bar-college" class="h-full bg-blue-500 rounded-full transition-all duration-700" style="width:0%"></div>
            </div>
        </div>
        <div class="glass rounded-xl p-4 glow-amber">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs text-gray-500 uppercase font-semibold">High School</p>
                <span class="px-2 py-0.5 rounded-full text-xs bg-amber-900/50 text-amber-400 font-bold">LVL 2</span>
            </div>
            <p id="stat-hs" class="text-3xl font-black text-amber-400">--</p>
            <div class="mt-2 w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="bar-hs" class="h-full bg-amber-500 rounded-full transition-all duration-700" style="width:0%"></div>
            </div>
        </div>
        <div class="glass rounded-xl p-4 glow-purple">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs text-gray-500 uppercase font-semibold">Youth</p>
                <span class="px-2 py-0.5 rounded-full text-xs bg-purple-900/50 text-purple-400 font-bold">LVL 3</span>
            </div>
            <p id="stat-youth" class="text-3xl font-black text-purple-400">--</p>
            <div class="mt-2 w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="bar-youth" class="h-full bg-purple-500 rounded-full transition-all duration-700" style="width:0%"></div>
            </div>
        </div>
    </div>

    <!-- Two-column: Crawler Status + Live Email Feed -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Crawler Status -->
        <div class="glass rounded-2xl overflow-hidden">
            <div class="px-5 py-3 border-b border-gray-800/50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div id="crawler-dot" class="w-2 h-2 rounded-full bg-gray-600"></div>
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Crawler Status</h2>
                </div>
                <span id="crawler-status-text" class="text-xs text-gray-600 font-mono">IDLE</span>
            </div>
            <div id="crawler-viz" class="p-5 min-h-[300px]">
                <!-- Idle state -->
                <div id="viz-idle" class="flex flex-col items-center justify-center h-full py-10">
                    <div class="relative w-32 h-32 mb-4">
                        <div class="absolute inset-0 rounded-full border border-gray-800/50"></div>
                        <div class="absolute inset-4 rounded-full border border-gray-800/30"></div>
                        <div class="absolute inset-8 rounded-full border border-gray-800/20"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-3 h-3 rounded-full bg-gray-700"></div>
                        </div>
                        <!-- Radar sweep -->
                        <div class="absolute inset-0" style="animation: radar-sweep 8s linear infinite;">
                            <div class="w-1/2 h-0.5 bg-gradient-to-r from-emerald-500/30 to-transparent absolute top-1/2 left-1/2 origin-left" style="transform-origin: left center;"></div>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm">Press <span class="text-emerald-600 font-bold">CRAWL</span> to begin</p>
                </div>
                <!-- Active state -->
                <div id="viz-active" class="hidden space-y-3"></div>
            </div>
        </div>

        <!-- Live Email Feed -->
        <div class="glass rounded-2xl overflow-hidden">
            <div class="px-5 py-3 border-b border-gray-800/50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div id="feed-dot" class="w-2 h-2 rounded-full bg-gray-600"></div>
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Live Email Feed</h2>
                </div>
                <span id="feed-count" class="text-xs text-gray-600 font-mono">0 new</span>
            </div>
            <div id="email-feed" class="divide-y divide-gray-800/50 max-h-[340px] overflow-y-auto">
                <div class="p-8 text-center text-gray-600 text-sm">
                    <svg class="w-10 h-10 mx-auto mb-3 text-gray-800" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/></svg>
                    <p>Emails will appear here during crawling</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Status banner -->
    <div id="status-banner" class="hidden glass rounded-xl p-4 border-l-4 border-emerald-500">
        <p id="crawl-status" class="text-sm text-emerald-300 font-medium"></p>
    </div>

    <!-- Terminal log -->
    <div id="terminal-section" class="hidden">
        <div class="glass rounded-2xl overflow-hidden">
            <div class="px-4 py-2.5 border-b border-gray-800/50 flex items-center gap-2">
                <div class="flex gap-1.5">
                    <div class="w-3 h-3 rounded-full bg-red-500/70"></div>
                    <div class="w-3 h-3 rounded-full bg-amber-500/70"></div>
                    <div class="w-3 h-3 rounded-full bg-emerald-500/70"></div>
                </div>
                <span class="text-xs text-gray-500 font-mono ml-2">crawler.log</span>
            </div>
            <div id="terminal-log" class="p-4 font-mono text-xs max-h-48 overflow-y-auto bg-gray-950/50 space-y-0.5"></div>
        </div>
    </div>

    <!-- Recent crawls -->
    <div>
        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Recent Crawls</h2>
        <div id="recent-crawls" class="glass rounded-2xl divide-y divide-gray-800/30">
            <p class="p-4 text-gray-600 text-sm">Loading...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let activeCrawls = {};
let baseEmailCount = 0;
let crawlRunning = false;
let lastSeenCoachId = 0;
let feedEmails = [];
let emailPollInterval = null;

// ── Stats ──────────────────────────────────────────────
async function loadStats() {
    try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        baseEmailCount = data.coaches.total;

        document.getElementById('stat-emails').textContent = data.coaches.total.toLocaleString();
        document.getElementById('stat-schools').textContent = data.schools.total.toLocaleString();
        document.getElementById('stat-crawled').textContent = data.schools.crawled.toLocaleString();
        document.getElementById('stat-pending').textContent = data.schools.pending.toLocaleString();

        // Level breakdown
        const byLevel = {};
        (data.by_level || []).forEach(l => byLevel[l.level] = l.count);
        document.getElementById('stat-college').textContent = (byLevel.college || 0).toLocaleString();
        document.getElementById('stat-hs').textContent = (byLevel.high_school || 0).toLocaleString();
        document.getElementById('stat-youth').textContent = (byLevel.youth || 0).toLocaleString();

        // Level proportion bars
        const total = data.coaches.total || 1;
        document.getElementById('bar-college').style.width = ((byLevel.college || 0) / total * 100).toFixed(0) + '%';
        document.getElementById('bar-hs').style.width = ((byLevel.high_school || 0) / total * 100).toFixed(0) + '%';
        document.getElementById('bar-youth').style.width = ((byLevel.youth || 0) / total * 100).toFixed(0) + '%';

        // Reconnect to running crawls on page load
        const running = data.recent_crawls.filter(c => c.status === 'running' || c.status === 'starting');
        if (running.length > 0 && !crawlRunning) {
            crawlRunning = true;
            running.forEach(c => {
                activeCrawls[c.id] = { spider: c.spider_name, coaches_found: c.coaches_found || 0, status: c.status, urls_completed: c.urls_completed || 0, urls_total: c.urls_total || 0 };
                connectSSE(c.id);
            });
            const queued = data.recent_crawls.filter(c => c.status === 'queued');
            queued.forEach(c => {
                activeCrawls[c.id] = { spider: c.spider_name, coaches_found: 0, status: 'queued', urls_completed: 0, urls_total: 0 };
                connectSSE(c.id);
            });
            disableButton();
            renderActive();
            startEmailPolling();
        }

        renderRecent(data.recent_crawls);

        // Initialize lastSeenCoachId
        if (lastSeenCoachId === 0) {
            const coachRes = await fetch('/api/coaches?limit=1&sort=id&order=desc');
            const coachData = await coachRes.json();
            if (coachData.coaches.length > 0) {
                lastSeenCoachId = coachData.coaches[0].id;
            }
        }
    } catch(e) { console.error(e); }
}

// ── Status / Button ────────────────────────────────────
function setStatus(msg) {
    const banner = document.getElementById('status-banner');
    document.getElementById('crawl-status').textContent = msg;
    banner.classList.remove('hidden');
}

function hideStatus() {
    document.getElementById('status-banner').classList.add('hidden');
}

function disableButton() {
    const btn = document.getElementById('crawl-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="w-2 h-2 bg-white rounded-full animate-pulse-green inline-block mr-2"></span>CRAWLING';
    btn.classList.replace('bg-emerald-600', 'bg-gray-700');
    btn.classList.replace('hover:bg-emerald-500', 'hover:bg-gray-700');
    btn.classList.remove('glow-emerald', 'hover:shadow-emerald-500/25');
}

function enableButton() {
    const btn = document.getElementById('crawl-btn');
    btn.disabled = false;
    btn.textContent = 'CRAWL';
    btn.classList.replace('bg-gray-700', 'bg-emerald-600');
    btn.classList.replace('hover:bg-gray-700', 'hover:bg-emerald-500');
    btn.classList.add('glow-emerald', 'hover:shadow-emerald-500/25');
}

// ── Start Crawl ────────────────────────────────────────
async function startCrawl() {
    if (crawlRunning) return;
    crawlRunning = true;
    disableButton();
    setStatus('Seeding database...');
    logTerminal('Starting crawl pipeline...', 'info');

    try {
        const seedRes = await fetch('/api/seed-all', { method: 'POST' });
        const seedData = await seedRes.json();
        setStatus(`Seeded ${seedData.new_schools} new schools. Launching crawlers...`);
        logTerminal(`Seeded ${seedData.new_schools} new schools (${seedData.total_schools} total)`, 'success');

        const res = await fetch('/api/crawl-all', { method: 'POST' });
        const data = await res.json();

        if (data.jobs) {
            for (const job of data.jobs) {
                activeCrawls[job.crawl_id] = {
                    spider: job.spider_name,
                    level: job.level,
                    coaches_found: 0,
                    status: 'queued',
                    urls_completed: 0,
                    urls_total: 0,
                };
                connectSSE(job.crawl_id);
                logTerminal(`Queued: ${job.spider_name} (${job.level})`, 'spider');
            }
        }

        renderActive();
        startEmailPolling();
        setStatus('Crawling — college first, then high school, then youth seeds + extraction...');
    } catch (err) {
        setStatus('Error: ' + err.message);
        logTerminal('Error: ' + err.message, 'error');
        enableButton();
        crawlRunning = false;
    }
}

// ── Crawler Visualization ──────────────────────────────
function renderActive() {
    const ids = Object.keys(activeCrawls);
    const crawlerDot = document.getElementById('crawler-dot');
    const statusText = document.getElementById('crawler-status-text');
    const feedDot = document.getElementById('feed-dot');

    if (ids.length === 0) {
        document.getElementById('viz-idle').classList.remove('hidden');
        document.getElementById('viz-active').classList.add('hidden');
        crawlerDot.className = 'w-2 h-2 rounded-full bg-gray-600';
        statusText.textContent = 'IDLE';
        feedDot.className = 'w-2 h-2 rounded-full bg-gray-600';
        return;
    }

    document.getElementById('viz-idle').classList.add('hidden');
    document.getElementById('viz-active').classList.remove('hidden');
    crawlerDot.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse-green';
    feedDot.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse-green';

    const running = ids.filter(id => activeCrawls[id].status === 'running' || activeCrawls[id].status === 'starting');
    statusText.textContent = running.length > 0 ? `${running.length} ACTIVE` : 'FINISHING';
    statusText.className = 'text-xs font-mono ' + (running.length > 0 ? 'text-emerald-400' : 'text-gray-500');

    // Update email counter with bump
    const newTotal = ids.reduce((s, id) => s + (activeCrawls[id].coaches_found || 0), 0);
    const emailEl = document.getElementById('stat-emails');
    const newVal = (baseEmailCount + newTotal).toLocaleString();
    if (emailEl.textContent !== newVal) {
        emailEl.textContent = newVal;
        emailEl.classList.add('counter-bump');
        setTimeout(() => emailEl.classList.remove('counter-bump'), 300);
    }

    // Delta indicator
    if (newTotal > 0) {
        const deltaEl = document.getElementById('stat-emails-delta');
        deltaEl.textContent = `+${newTotal.toLocaleString()} this session`;
        deltaEl.classList.remove('hidden');
    }

    const container = document.getElementById('viz-active');
    container.innerHTML = ids.map(id => {
        const c = activeCrawls[id];
        const label = c.spider.replace(/_/g, ' ');
        const pct = c.urls_total > 0 ? Math.round((c.urls_completed / c.urls_total) * 100) : 0;
        const isActive = c.status === 'running' || c.status === 'starting';

        let statusColor, barColor, statusLabel;
        if (c.status === 'completed') { statusColor = 'text-emerald-400'; barColor = 'bg-emerald-500'; statusLabel = 'DONE'; }
        else if (c.status === 'failed') { statusColor = 'text-red-400'; barColor = 'bg-red-500'; statusLabel = 'FAILED'; }
        else if (isActive) { statusColor = 'text-emerald-400'; barColor = 'bg-emerald-500'; statusLabel = 'RUNNING'; }
        else { statusColor = 'text-gray-600'; barColor = 'bg-gray-700'; statusLabel = 'QUEUED'; }

        const levelBadge = c.level === 'college' ? 'bg-blue-900/50 text-blue-400'
            : c.level === 'high_school' ? 'bg-amber-900/50 text-amber-400'
            : c.level === 'youth_seed' ? 'bg-pink-900/50 text-pink-400'
            : c.level === 'youth' ? 'bg-purple-900/50 text-purple-400'
            : 'bg-gray-800 text-gray-400';

        return `
        <div class="rounded-lg p-3 ${isActive ? 'bg-emerald-950/20 border border-emerald-900/30' : 'bg-gray-900/30 border border-gray-800/30'}">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2 min-w-0">
                    <span class="w-1.5 h-1.5 rounded-full ${isActive ? 'bg-emerald-400 animate-pulse-green' : c.status === 'completed' ? 'bg-emerald-400' : c.status === 'failed' ? 'bg-red-400' : 'bg-gray-600'} inline-block flex-shrink-0"></span>
                    <span class="text-sm text-gray-300 font-medium truncate">${label}</span>
                    <span class="px-1.5 py-0.5 rounded text-xs ${levelBadge} flex-shrink-0">${c.level || ''}</span>
                </div>
                <div class="flex items-center gap-3 flex-shrink-0">
                    <span class="font-mono text-sm text-emerald-400 font-bold">${(c.coaches_found || 0).toLocaleString()}</span>
                    <span class="text-xs ${statusColor} font-bold w-16 text-right">${statusLabel}</span>
                </div>
            </div>
            <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden relative">
                <div class="h-full ${barColor} rounded-full transition-all duration-500" style="width:${pct}%"></div>
                ${isActive ? '<div class="absolute inset-0 progress-shimmer rounded-full"></div>' : ''}
            </div>
            <p class="text-xs text-gray-600 mt-1 text-right font-mono">${c.urls_completed || 0}/${c.urls_total || '?'} URLs ${pct > 0 ? '(' + pct + '%)' : ''}</p>
        </div>`;
    }).join('');
}

// ── Live Email Feed ────────────────────────────────────
function startEmailPolling() {
    if (emailPollInterval) return;
    emailPollInterval = setInterval(pollNewEmails, 3000);
}

function stopEmailPolling() {
    if (emailPollInterval) { clearInterval(emailPollInterval); emailPollInterval = null; }
}

async function pollNewEmails() {
    if (!crawlRunning) return;
    try {
        const res = await fetch('/api/coaches?limit=10&sort=id&order=desc');
        const data = await res.json();
        const newOnes = data.coaches.filter(c => c.id > lastSeenCoachId);
        if (newOnes.length > 0 && lastSeenCoachId > 0) {
            newOnes.reverse().forEach(c => addEmailToFeed(c));
            document.getElementById('feed-count').textContent = `${feedEmails.length} new`;
            document.getElementById('feed-count').className = 'text-xs text-emerald-400 font-mono';
        }
        if (data.coaches.length > 0) {
            lastSeenCoachId = Math.max(...data.coaches.map(c => c.id));
        }
    } catch(e) { console.error('Email poll error:', e); }
}

function addEmailToFeed(coach) {
    feedEmails.unshift(coach);
    const container = document.getElementById('email-feed');

    // Remove placeholder
    const placeholder = container.querySelector('.text-center');
    if (placeholder) container.innerHTML = '';

    const entry = document.createElement('div');
    entry.className = 'px-5 py-3 animate-slide-in';

    const levelColor = coach.level === 'college' ? 'bg-blue-900/50 text-blue-400'
        : coach.level === 'high_school' ? 'bg-amber-900/50 text-amber-400'
        : 'bg-purple-900/50 text-purple-400';

    entry.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="min-w-0 flex-1">
                <p class="text-emerald-400 font-mono text-sm truncate">${coach.email}</p>
                <p class="text-gray-500 text-xs mt-0.5 truncate">${coach.full_name || ''}${coach.title ? ' &middot; ' + coach.title : ''}</p>
            </div>
            <div class="flex items-center gap-2 ml-3 flex-shrink-0">
                <span class="px-1.5 py-0.5 rounded text-xs ${levelColor}">${coach.level}</span>
                <span class="text-gray-600 text-xs">${coach.state || ''}</span>
            </div>
        </div>
        <p class="text-gray-700 text-xs mt-1 truncate">${coach.school_name || ''}</p>
    `;

    container.insertBefore(entry, container.firstChild);
    while (container.children.length > 50) container.removeChild(container.lastChild);
}

// ── Terminal Log ───────────────────────────────────────
function logTerminal(msg, type) {
    document.getElementById('terminal-section').classList.remove('hidden');
    const log = document.getElementById('terminal-log');
    const colors = { info: 'text-gray-500', success: 'text-emerald-400', error: 'text-red-400', warn: 'text-amber-400', spider: 'text-blue-400' };
    const time = new Date().toLocaleTimeString('en-US', { hour12: false });
    const line = document.createElement('p');
    line.className = colors[type] || 'text-gray-500';
    line.textContent = `[${time}] ${msg}`;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
    while (log.children.length > 200) log.removeChild(log.firstChild);
}

// ── Recent Crawls ──────────────────────────────────────
function renderRecent(crawls) {
    const container = document.getElementById('recent-crawls');
    const activeIds = new Set(Object.keys(activeCrawls));
    const past = crawls.filter(c => !activeIds.has(String(c.id)) && (c.status === 'completed' || c.status === 'failed'));

    if (past.length === 0) {
        container.innerHTML = '<p class="p-4 text-gray-600 text-sm">No completed crawls yet.</p>';
        return;
    }

    container.innerHTML = past.slice(0, 15).map(c => {
        const color = c.status === 'completed' ? 'text-emerald-400' : 'text-red-400';
        const time = c.started_at ? new Date(c.started_at).toLocaleString() : '';
        const name = c.spider_name.replace(/_/g, ' ');
        return `<div class="flex items-center justify-between px-4 py-3 text-sm hover:bg-gray-800/20 transition">
            <div>
                <span class="text-gray-300">${name}</span>
                <span class="text-gray-600 text-xs ml-2">${time}</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="font-mono text-emerald-400">${(c.coaches_found || 0).toLocaleString()} emails</span>
                <span class="${color} font-bold text-xs uppercase">${c.status}</span>
            </div>
        </div>`;
    }).join('');
}

// ── SSE ────────────────────────────────────────────────
function connectSSE(crawlId) {
    const sse = new EventSource(`/api/events/crawl/${crawlId}`);

    sse.addEventListener('progress', (e) => {
        const data = JSON.parse(e.data);
        if (activeCrawls[crawlId]) {
            const prev = activeCrawls[crawlId].coaches_found || 0;
            activeCrawls[crawlId].coaches_found = data.coaches_found || 0;
            activeCrawls[crawlId].status = data.status;
            activeCrawls[crawlId].urls_completed = data.urls_completed || 0;
            activeCrawls[crawlId].urls_total = data.urls_total || 0;

            const delta = (data.coaches_found || 0) - prev;
            if (delta > 0) {
                logTerminal(`${activeCrawls[crawlId].spider}: +${delta} emails (${data.coaches_found} total)`, 'success');
            } else if (data.status === 'running' && data.urls_completed > 0) {
                logTerminal(`${activeCrawls[crawlId].spider}: ${data.urls_completed}/${data.urls_total} URLs processed`, 'spider');
            }
        }
        renderActive();
    });

    sse.addEventListener('completed', (e) => {
        const data = JSON.parse(e.data);
        if (activeCrawls[crawlId]) {
            activeCrawls[crawlId].coaches_found = data.coaches_found || 0;
            activeCrawls[crawlId].status = 'completed';
            logTerminal(`${activeCrawls[crawlId].spider}: Completed with ${data.coaches_found} emails`, 'success');
        }
        sse.close();
        renderActive();
        checkAllDone();
    });

    sse.addEventListener('failed', () => {
        if (activeCrawls[crawlId]) {
            logTerminal(`${activeCrawls[crawlId].spider}: FAILED`, 'error');
            activeCrawls[crawlId].status = 'failed';
        }
        sse.close();
        renderActive();
        checkAllDone();
    });
}

function checkAllDone() {
    const all = Object.values(activeCrawls);
    if (all.every(c => c.status === 'completed' || c.status === 'failed')) {
        const newFound = all.reduce((sum, c) => sum + (c.coaches_found || 0), 0);
        setStatus(newFound > 0
            ? `Crawl complete — ${newFound.toLocaleString()} new coaching emails found.`
            : 'Crawl complete — no new emails (schools already crawled).');
        logTerminal(`Pipeline complete. ${newFound} total emails found.`, newFound > 0 ? 'success' : 'warn');
        enableButton();
        crawlRunning = false;
        stopEmailPolling();
        activeCrawls = {};
        renderActive();
        loadStats();
    }
}

// ── Init ───────────────────────────────────────────────
loadStats();
setInterval(() => { if (!crawlRunning) loadStats(); }, 10000);
</script>
{% endblock %}
