{% extends "base.html" %}
{% block title %}Schools - Coach Crawler{% endblock %}
{% block nav_schools %}text-white active{% endblock %}

{% block content %}
<div class="space-y-6">
    <h1 class="text-3xl font-bold">Schools</h1>

    <!-- Search + Filters -->
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-4">
        <div class="flex flex-wrap gap-3">
            <input id="search" type="text" placeholder="Search schools, cities, URLs..."
                class="flex-1 min-w-[200px] bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
            <select id="filter-level" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5 text-white text-sm">
                <option value="">All Levels</option>
                <option value="college">College</option>
                <option value="high_school">High School</option>
                <option value="youth">Youth</option>
            </select>
            <select id="filter-division" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5 text-white text-sm">
                <option value="">All Divisions</option>
                <option value="NCAA_D1_FBS">NCAA D1 FBS</option>
                <option value="NCAA_D1_FCS">NCAA D1 FCS</option>
                <option value="NCAA_D2">NCAA D2</option>
                <option value="NCAA_D3">NCAA D3</option>
                <option value="NAIA">NAIA</option>
                <option value="NJCAA">NJCAA</option>
            </select>
            <select id="filter-state" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5 text-white text-sm">
                <option value="">All States</option>
            </select>
            <select id="filter-status" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5 text-white text-sm">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="crawled">Crawled</option>
                <option value="failed">Failed</option>
            </select>
        </div>
    </div>

    <!-- Results count -->
    <div class="flex justify-between items-center text-sm text-gray-400">
        <span id="result-count">Loading...</span>
        <div class="flex items-center gap-2">
            <button id="prev-btn" onclick="changePage(-1)" disabled class="px-3 py-1 bg-gray-800 rounded disabled:opacity-30">Prev</button>
            <span id="page-info">Page 1</span>
            <button id="next-btn" onclick="changePage(1)" class="px-3 py-1 bg-gray-800 rounded disabled:opacity-30">Next</button>
        </div>
    </div>

    <!-- Table -->
    <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-800/50">
                    <tr>
                        <th class="text-left px-4 py-3 text-gray-400 font-medium cursor-pointer hover:text-white" onclick="sortBy('name')">Name</th>
                        <th class="text-left px-4 py-3 text-gray-400 font-medium">Level</th>
                        <th class="text-left px-4 py-3 text-gray-400 font-medium">Division</th>
                        <th class="text-left px-4 py-3 text-gray-400 font-medium">State</th>
                        <th class="text-left px-4 py-3 text-gray-400 font-medium">City</th>
                        <th class="text-left px-4 py-3 text-gray-400 font-medium">Athletics URL</th>
                        <th class="text-left px-4 py-3 text-gray-400 font-medium">Status</th>
                        <th class="text-left px-4 py-3 text-gray-400 font-medium cursor-pointer hover:text-white" onclick="sortBy('coach_count')">Coaches</th>
                    </tr>
                </thead>
                <tbody id="school-table" class="divide-y divide-gray-800">
                    <tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let currentSort = 'id';
let currentOrder = 'desc';
let debounceTimer;

const STATES = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
const stateSelect = document.getElementById('filter-state');
STATES.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = s;
    stateSelect.appendChild(opt);
});

async function loadSchools() {
    const params = new URLSearchParams({
        page: currentPage,
        limit: 50,
        sort: currentSort,
        order: currentOrder,
    });

    const search = document.getElementById('search').value;
    const level = document.getElementById('filter-level').value;
    const division = document.getElementById('filter-division').value;
    const state = document.getElementById('filter-state').value;
    const status = document.getElementById('filter-status').value;

    if (search) params.set('search', search);
    if (level) params.set('level', level);
    if (division) params.set('division', division);
    if (state) params.set('state', state);
    if (status) params.set('crawl_status', status);

    const res = await fetch(`/api/schools?${params}`);
    const data = await res.json();

    document.getElementById('result-count').textContent = `${data.total.toLocaleString()} schools`;
    document.getElementById('page-info').textContent = `Page ${data.page} of ${data.pages}`;
    document.getElementById('prev-btn').disabled = data.page <= 1;
    document.getElementById('next-btn').disabled = data.page >= data.pages;

    const tbody = document.getElementById('school-table');
    if (data.schools.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No schools found</td></tr>';
        return;
    }

    tbody.innerHTML = data.schools.map(s => {
        const statusClass = s.crawl_status === 'crawled' ? 'bg-emerald-900/50 text-emerald-400' :
                           s.crawl_status === 'failed' ? 'bg-red-900/50 text-red-400' :
                           'bg-gray-800 text-gray-400';
        const levelClass = s.level === 'college' ? 'bg-blue-900/50 text-blue-400' :
                          s.level === 'high_school' ? 'bg-amber-900/50 text-amber-400' :
                          'bg-purple-900/50 text-purple-400';
        const urlDisplay = s.athletics_url ? (s.athletics_url.length > 40 ? s.athletics_url.substring(0, 40) + '...' : s.athletics_url) : '';
        const urlLink = s.athletics_url ? `<a href="${s.athletics_url}" target="_blank" class="text-emerald-400 hover:text-emerald-300">${urlDisplay}</a>` : '<span class="text-gray-600">—</span>';

        return `
            <tr class="hover:bg-gray-800/50 transition">
                <td class="px-4 py-3 font-medium">${s.name}</td>
                <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-xs ${levelClass}">${s.level}</span></td>
                <td class="px-4 py-3 text-gray-400 text-xs">${s.division || '—'}</td>
                <td class="px-4 py-3 text-center">${s.state || '—'}</td>
                <td class="px-4 py-3 text-gray-400">${s.city || '—'}</td>
                <td class="px-4 py-3 text-xs font-mono">${urlLink}</td>
                <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-xs ${statusClass}">${s.crawl_status}</span></td>
                <td class="px-4 py-3 text-center">${s.coach_count > 0 ? `<a href="/coaches?search=${encodeURIComponent(s.name)}" class="text-emerald-400 hover:text-emerald-300">${s.coach_count}</a>` : '<span class="text-gray-600">0</span>'}</td>
            </tr>`;
    }).join('');
}

function changePage(delta) {
    currentPage += delta;
    if (currentPage < 1) currentPage = 1;
    loadSchools();
}

function sortBy(col) {
    if (currentSort === col) {
        currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort = col;
        currentOrder = 'asc';
    }
    currentPage = 1;
    loadSchools();
}

document.getElementById('search').addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => { currentPage = 1; loadSchools(); }, 300);
});

['filter-level', 'filter-division', 'filter-state', 'filter-status'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => { currentPage = 1; loadSchools(); });
});

loadSchools();
</script>
{% endblock %}
